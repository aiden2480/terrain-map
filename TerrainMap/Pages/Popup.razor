@page "/popup.html"
@inherits BasePage
@inject ILocalAuthService AuthService
@inject ITerrainApiService TerrainApiService

@popupFragment

@code {
    private RenderFragment popupFragment = null!;

    protected override async Task OnInitializedAsync()
        => popupFragment = await GetPopupFragment();

    async Task<RenderFragment> GetPopupFragment()
    {
        if (!await AuthService.IsAuthenticated())
        {
            return @<Login OnLoginSuccess="OnInitializedAsync" />;
        }

        var profiles = await TerrainApiService.GetProfiles();
        var profile = profiles.First(p => p.Unit is not null);
        var pendingApprovals = await TerrainApiService.GetPendingApprovals(profile.Unit!.Id);

        return @<ViewPendingApprovals CurrentProfile="@profile" PendingApprovals="@pendingApprovals" />;
    }
}
