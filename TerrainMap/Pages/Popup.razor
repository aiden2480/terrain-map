@page "/popup.html"
@inherits BasePage

@popupFragment

@code {
    private RenderFragment popupFragment = null!;

    protected override async Task OnInitializedAsync()
        => popupFragment = await GetPopupFragment();

    async Task<RenderFragment> GetPopupFragment()
    {
        if (!await StorageService.IsAuthenticated())
        {
            return @<Login OnLoginSuccess="OnInitializedAsync" />;
        }

        // Attempt to get an applicable profile.
        // If none exist, refresh cache, and try again
        var profile = await GetFirstProfileInUnitCouncil() ?? await GetFirstProfileInUnitCouncil(true);

        if (profile is not null)
        {
            return @<ViewPendingApprovals CurrentProfile="@profile" />;
        }
        else
        {
            return @<MudAlert Severity="Severity.Error">You are not a member of the unit council for any units. Ask your unit leader to add you, then try again</MudAlert>;
        }
    }
}
